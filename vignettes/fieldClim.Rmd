---
title: "Introduction to fieldClim"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to fieldClim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction to the Package

The `fieldClim` package was originally designed as a course project to the course `Geländeklimatologie`, held by Prof. Dr. Jörg Bendix at the Philipps-University of Marburg in summer term 2020. Thus, the calculations and formulas of this package are based on this course, as well as the book `Geländeklimatologie` (Field climatology) by Jörg Bendix (2004; ISBN 978-3-443-07139-4).

`fieldClim` is designed as a handy tool, that lets you calculate various weather and micro-climate conditions, based on the measurements of a weather station. It lets you create a `weather_station`-object, that can then be used to call most of the functions without the necessity of further specify input variables. In addition, all functions can also be called by manually inputting the needed variables, if the user whishes to do so.

Here, we will provide an example of the calculation of a set of micro-climate conditions using the `weather_station`-object, based on the `weather_station_example_data` data frame, that is included in the package.

## Preparing the data

First let's load the package and the provided example-data and take a look at the provided columns.

```{r}
library(fieldClim)
ws <- get(data(weather_station_example_data, package="fieldClim"))

colnames(ws)
```

This dataset includes most of the data necessary to run the functions in this package.

Before building a `weather_station` object it is necessary to ensure that the input is properly formatted.
For this we need to check if the `datetime` column is in `POSIXt`-format and if not convert it.

```{r}
# Check datetime class
class(ws$datetime)

# Looks good! However just to demonstrate here's how to convert to POSIXt:
wrong_type <- as.character(ws$datetime)
class(wrong_type)

ws$datetime <- strptime(wrong_type, format = "%Y-%m-%d %H:%M:%S")
# or
ws$datetime <- as.POSIXlt(wrong_type)

```

It is also necessary to check if all other columns containing data are `numeric`. Most functions provided by `fieldClim` require `numeric` input. Some functions will automatically try to convert to `numeric`, however this will sometimes lead to unexpected side-effects so it is always best to ensure the proper data format for yourself.

```{r}
# Check if any remaining classes are not numeric
colnames(Filter(Negate(is.numeric), ws))

```

Looks like only the `datetime` column is not numeric which is appropriate. If this wasn't the case, other columns might have to be converted using `as.numeric()`.


## Building a weather_station object

If the dataframe is properly formatted (date column as `POSIXt`, all other necessary columns `numeric`), the function `build_weather_station()` can be used to conveniently create a `weather_station` object.

You can get more info about the single parameters by calling `?build_weather_station`.

```{r}
test_station <- build_weather_station(lat = 50.840503,
                                      lon = 8.6833,
                                      elev = 270,
                                      surface_type = "Meadow",
                                      obs_height = 0.3, # obstacle height
                                      z1 = 2, # measurement heights
                                      z2 = 10,
                                      datetime = ws$datetime,
                                      t1 = ws$t1, # temperature
                                      t2 = ws$t2,
                                      v1 = ws$v1, # windspeed
                                      v2 = ws$v2,
                                      hum1 = ws$hum1, # humidity
                                      hum2 = ws$hum2,
                                      sw_in = ws$rad_sw_in, # shortwave radiation
                                      sw_out = ws$rad_sw_out,
                                      lw_in = ws$rad_lw_in, # longwave radiation
                                      lw_out = ws$rad_lw_out,
                                      soil_flux = ws$heatflux_soil)

# We can see that this is indeed a weather_station object.
class(test_station)
```

This is close to the minimum amount of parameters necessary to build a `weather_station` object. 

Many of the parameters can however also be estimated using different inputs.
Below is an overview on which parameters can be omitted or estimated another way.

### Adding air pressure

By default the air pressure at the measurment heights is estimated using the temperature and the elevation (using `pres_p()`). If the pressure is measured at the weather station it can be added to the call using the parameters `p1` and `p2`. 

```{r}
test_station <- build_weather_station(lat = 50.840503,
                                      lon = 8.6833,
                                      elev = 270,
                                      surface_type = "Meadow",
                                      obs_height = 0.3,
                                      z1 = 2,
                                      z2 = 10,
                                      datetime = ws$datetime,
                                      t1 = ws$t1,
                                      t2 = ws$t2,
                                      v1 = ws$v1,
                                      v2 = ws$v2,
                                      hum1 = ws$hum1,
                                      hum2 = ws$hum2,
                                      sw_in = ws$rad_sw_in,
                                      sw_out = ws$rad_sw_out,
                                      lw_in = ws$rad_lw_in,
                                      lw_out = ws$rad_lw_out,
                                      soil_flux = ws$heatflux_soil,
                                      # ADDED PRESSURE
                                      p1 = ws$p1,
                                      p2 = ws$p2)
```


Note: If the pressure at the station is only measured at one height, it will also be applied to the other height since the measured pressure is assumed to be much more accurate than the estimated pressure.

### Missing soil flux

If the soil flux is not measured by a heat flux plate but by two soil temperature measurements at different depths, those measurements can also be provided to calculate `soil_flux` from them instead.

For this the two depths of the temperature probes from the surface in meters, the two temperature measurements in degrees Celsius as well as the soil texture ("clay" or "sand") and soil moisture (Vol-%) are necessary.

Internally the calculations are provided by the two functions `soil_heat_flux()` and `soil_thermal_cond()`.

```{r}
test_station <- build_weather_station(lat = 50.840503,
                                      lon = 8.6833,
                                      elev = 270,
                                      surface_type = "Meadow",
                                      obs_height = 0.3,
                                      z1 = 2,
                                      z2 = 10,
                                      datetime = ws$datetime,
                                      t1 = ws$t1,
                                      t2 = ws$t2,
                                      v1 = ws$v1,
                                      v2 = ws$v2,
                                      hum1 = ws$hum1,
                                      hum2 = ws$hum2,
                                      sw_in = ws$rad_sw_in,
                                      sw_out = ws$rad_sw_out,
                                      lw_in = ws$rad_lw_in,
                                      lw_out = ws$rad_lw_out,
                                      # Alternative Soil flux:
                                      depth1 = 0,
                                      depth2 = 0.3,
                                      ts1 = ws$t_surface,
                                      ts2 = ws$ts1,
                                      moisture = ws$water_vol_soil,
                                      texture = "clay")
```


### Missing shortwave radiation

The two 

If sw_in is NULL, it will get estimated using TOA radiation and average atmospheric transmission (see rad_sw_in). By setting slope, sky_view and exposition, sw_in will be topographically corrected (see rad_sw_in_topo).

If sw_out is NULL, albedo needs to be set (see rad_sw_out).


### Missing longwave radiation
